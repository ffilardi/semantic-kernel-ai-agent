<policies>
    <inbound>
        <base />
        <authentication-managed-identity
            resource="https://cognitiveservices.azure.com/"
            output-token-variable-name="managed-id-access-token"
            ignore-error="false"
        />
        <set-header name="Authorization" exists-action="override">
            <value>@("Bearer " + (string)context.Variables["managed-id-access-token"])</value>
        </set-header>
        <set-backend-service
            id="aifoundry-pool"
            backend-id="ai-foundry-backend-pool"
        />
        <quota-by-key
            calls="6000"
            renewal-period="3600"
            counter-key="@(context.Subscription?.Key ?? "anonymous")"
        />
        <rate-limit-by-key
            calls="100"
            renewal-period="60"
            counter-key="@(context.Subscription?.Key ?? "anonymous")"
        />
        <llm-emit-token-metric>
            <dimension name="API ID" />
        </llm-emit-token-metric>
        <llm-token-limit
            tokens-per-minute="100000"
            tokens-consumed-header-name="x-apim-ratelimit-consumed-tokens"
            remaining-tokens-header-name="x-apim-ratelimit-remaining-tokens"
            token-quota="6000000"
            token-quota-period="Hourly"
            remaining-quota-tokens-header-name="x-apim-ratelimit-remaining-quota-tokens"
            counter-key="@(context.Request.IpAddress)"
            estimate-prompt-tokens="true"
        />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>